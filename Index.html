<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>SUS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

  <style>
    :root{
      --olive-900:#0b120b; --olive-850:#0d160d;
      --accent:#7aa83f; --accent-2:#b7d36b; --danger:#ef4444;
      --text:#e7efe6; --muted:rgba(231,239,230,.68);
      --border:rgba(183,211,107,.22); --shadow:0 18px 45px rgba(0,0,0,.70);
      --card:rgba(12, 20, 12, .78); --card2:rgba(12, 20, 12, .86);
      --input:rgba(7, 12, 7, .72); --chip:rgba(12, 20, 12, .65);
    }
    body.light{
      --olive-900:#f7faf7; --olive-850:#ffffff;
      --text:#0b120b; --muted:rgba(11,18,11,.62);
      --border:rgba(122,168,63,.25); --shadow:0 18px 45px rgba(15,23,42,.12);
      --card:#ffffff; --card2:#ffffff; --input:#ffffff; --chip:rgba(122,168,63,.10);
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:"Cairo",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      color:var(--text);
      background:
        radial-gradient(circle at 12% 10%, rgba(122,168,63,.24), transparent 45%),
        radial-gradient(circle at 88% 18%, rgba(183,211,107,.14), transparent 42%),
        radial-gradient(circle at 70% 90%, rgba(122,168,63,.18), transparent 48%),
        linear-gradient(135deg, var(--olive-900), #000 55%, var(--olive-850));
      min-height:100vh;
    }
    body.light{
      background:
        radial-gradient(circle at 12% 10%, rgba(122,168,63,.15), transparent 50%),
        radial-gradient(circle at 88% 18%, rgba(183,211,107,.12), transparent 50%),
        linear-gradient(135deg, #f2f7f2, #ffffff 60%, #eef6ee);
    }
    .topbar{
      width:min(1180px, 100%);
      margin:18px auto 14px;
      padding:14px 16px;
      border-radius:18px;
      background:var(--card);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      backdrop-filter: blur(14px);
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.4px}
    .brand .dot{width:10px;height:10px;border-radius:999px;background:var(--accent);box-shadow:0 0 0 4px rgba(122,168,63,.18)}
    .brand .title{font-size:18px;text-transform:uppercase}
    .actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      border:1px solid var(--border);
      background:var(--chip);
      color:var(--text);
      border-radius:999px;
      padding:7px 12px;
      font-size:12px;
      cursor:pointer;
      display:inline-flex;align-items:center;gap:8px;
      user-select:none;
    }
    .pill:hover{filter:brightness(1.06)}
    .pill strong{font-weight:800}
    .pill .kbd{font-size:10px;opacity:.75;padding:2px 6px;border-radius:999px;border:1px solid var(--border);background:rgba(0,0,0,.18)}
    body.light .pill .kbd{background:rgba(122,168,63,.08)}

    .layout{
      width:min(1180px, 100%);
      margin:0 auto;
      padding:0 12px 22px;
      display:grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 330px);
      gap:14px;
      align-items:start;
    }
    .card{
      border-radius:22px;
      background:var(--card2);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      padding:16px;
      position:relative;
      overflow:hidden;
    }
    .card h2{font-size:18px;margin-bottom:4px;font-weight:800}
    .card p{color:var(--muted);font-size:13px;margin-bottom:14px}

    .video-grid{display:grid;grid-template-columns: repeat(2, minmax(0, 1fr));gap:12px}
    .video-box{
      border-radius:18px;
      background:rgba(0,0,0,.14);
      border:1px solid rgba(183,211,107,.18);
      padding:10px;
      display:flex;flex-direction:column;gap:8px;
      min-height:230px;
    }
    body.light .video-box{background:rgba(122,168,63,.06)}
    .video-label{font-size:12px;color:var(--muted)}
    video{width:100%;border-radius:14px;background:#000;min-height:180px}
    #localVideo.mirrored{transform:scaleX(-1)}

    .remote-grid{display:grid;grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));gap:8px}
    .remote-video-wrapper{position:relative}
    .remote-peer-label{
      position:absolute;right:8px;bottom:8px;
      background:rgba(0,0,0,.55);
      border:1px solid rgba(183,211,107,.22);
      color:#fff;font-size:10px;padding:2px 8px;border-radius:999px;
      max-width:92%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    .fullscreen-btn{
      position:absolute;top:10px;left:10px;
      border:none;border-radius:999px;padding:4px 10px;
      font-size:12px;cursor:pointer;background:rgba(0,0,0,.52);color:#fff;
    }
    .statusbar{
      margin-top:10px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;
      font-size:12px;color:var(--muted);
      border-top:1px dashed rgba(183,211,107,.22);
      padding-top:10px;
    }
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .ok{color:var(--accent-2);font-weight:800}

    .chat{
      margin-top:12px;border-radius:18px;background:rgba(0,0,0,.12);
      border:1px solid rgba(183,211,107,.18);
      padding:10px;display:flex;flex-direction:column;gap:8px;
    }
    body.light .chat{background:rgba(122,168,63,.06)}
    .chat-head{display:flex;align-items:center;justify-content:space-between;font-size:12px;color:var(--muted)}
    .chat-messages{max-height:220px;overflow:auto;display:flex;flex-direction:column;gap:6px;padding:2px}
    .msg{
      border:1px solid rgba(183,211,107,.18);
      background:rgba(0,0,0,.18);
      border-radius:14px;
      padding:6px 8px;
      max-width:92%;
    }
    body.light .msg{background:rgba(122,168,63,.07)}
    .msg.own{margin-inline-start:auto;background:rgba(122,168,63,.14)}
    .msg .meta{font-size:10px;color:var(--muted);margin-bottom:2px}
    .msg a{color:var(--accent-2);text-decoration:underline}
    .chat-form{display:flex;gap:8px;align-items:center}
    .chat-input{
      flex:1;border-radius:999px;border:1px solid rgba(183,211,107,.25);
      padding:8px 12px;background:var(--input);color:var(--text);outline:none;font-size:12px
    }
    .btn{border:none;border-radius:999px;padding:9px 14px;cursor:pointer;font-size:12px;font-weight:800}
    .btn.primary{background:linear-gradient(135deg, var(--accent), var(--accent-2)); color:#0b120b}
    .btn.danger{background:linear-gradient(135deg, #b91c1c, var(--danger)); color:#fff}
    .iconbtn{
      width:40px;height:40px;border-radius:999px;border:1px solid rgba(183,211,107,.22);
      background:rgba(0,0,0,.16);color:var(--text);cursor:pointer;
      display:flex;align-items:center;justify-content:center;font-size:18px;
    }
    body.light .iconbtn{background:rgba(122,168,63,.08)}
    .iconbtn.off{border-color:rgba(239,68,68,.55); color:#fecaca}

    .sidebar{
      border-radius:22px;background:var(--card2);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      padding:14px;position:sticky;top:14px;height:fit-content;
    }
    .sidebar h3{font-size:16px;font-weight:800;margin-bottom:6px}
    .sidebar p{font-size:12px;color:var(--muted);margin-bottom:12px;line-height:1.6}
    .section{padding:10px 0;border-top:1px dashed rgba(183,211,107,.22)}
    .section:first-of-type{border-top:none;padding-top:0}
    .label{font-size:12px;font-weight:800;margin-bottom:6px}
    .input{
      width:100%;padding:9px 10px;border-radius:12px;border:1px solid rgba(183,211,107,.25);
      background:var(--input);color:var(--text);outline:none;font-size:12px;
    }
    .hint{font-size:11px;color:var(--muted);margin-top:6px;line-height:1.6}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .row .btn{flex:1}

    #btnToggleSidebar{
      position:fixed;bottom:16px;right:16px;z-index:2000;
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 14px;border-radius:999px;border:1px solid rgba(183,211,107,.28);
      background:rgba(0,0,0,.35);color:#fff;font-weight:800;cursor:pointer;
      box-shadow:var(--shadow);backdrop-filter: blur(12px);
    }
    #overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:1500}

    body.meeting-only .topbar,
    body.meeting-only .sidebar,
    body.meeting-only #btnToggleSidebar,
    body.meeting-only #overlay{display:none !important}
    body.meeting-only .layout{grid-template-columns:1fr !important;width:100%;padding:0;margin:0}
    body.meeting-only .card{border-radius:0;border:none;box-shadow:none;padding:12px;min-height:100vh}

    @media (max-width: 980px){
      .layout{grid-template-columns:1fr}
      .sidebar{
        position:fixed;top:78px;right:12px;left:12px;bottom:12px;
        z-index:1600;overflow:auto;transform: translateY(120%);
        transition: transform .22s ease;
      }
      .sidebar.open{transform: translateY(0)}
      .video-grid{grid-template-columns:1fr}
      video{min-height:200px}
    }
    .footer{width:min(1180px, 100%);margin:10px auto 22px;padding:0 14px;color:var(--muted);font-size:12px;text-align:center}
  </style>
</head>

<body class="dark">
  <button id="btnToggleSidebar" type="button">âš™ï¸ <span id="toggleSidebarText">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§ØªØµØ§Ù„</span></button>
  <div id="overlay"></div>

  <header class="topbar">
    <div class="brand">
      <span class="dot"></span>
      <span class="title"></span>
      <h1>SUS.com</h1>
    </div>
    <div class="actions">
      <button class="pill" id="btnLang" type="button"><strong id="langLabel">AR</strong><span class="kbd">A</span></button>
      <button class="pill" id="btnTheme" type="button"><strong id="themeLabel">Dark</strong><span class="kbd">T</span></button>
    </div>
  </header>

  <main class="layout">
    <section class="card">
      <h2 id="pageTitle">Ù„Ù‚Ø§Ø¡ Ø§Ù„Ø³ÙˆØ³ ğŸ˜‚ </h2>
      <p id="pageSub"></p>

      <div class="video-grid">
        <div class="video-box">
          <div class="video-label" id="lblLocal">Ø§Ù†Ø§ ğŸ˜’</div>
          <div style="position:relative">
            <video id="localVideo" class="mirrored" autoplay muted playsinline></video>
            <button class="fullscreen-btn" type="button" id="btnFsLocal">â›¶</button>
          </div>
        </div>

        <div class="video-box">
          <div class="video-label" id="lblRemote">Ø§Ø­Ù„Ù‰ Ø®Ø·ÙŠØ¨Ù‡ Ø¨Ø§Ù„Ø¹Ø§Ù„Ù… ğŸ˜…</div>
          <div id="remoteVideosGrid" class="remote-grid"></div>
        </div>
      </div>

      <div class="statusbar">
        <span id="stLabel">Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„:</span>
        <span id="callStatus" class="ok">Ø¬Ø§Ù‡Ø²</span>
        <span> | </span>
        <span id="durLabel">Ø§Ù„Ù…Ø¯Ø©:</span>
        <span id="callTimer" class="mono">00:00</span>
        <span> | </span>
        <span id="cntLabel">Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙˆÙ†:</span>
        <span id="participantsCount" class="mono">1</span>
      </div>

      <div class="chat">
        <div class="chat-head">
          <span id="chatTitle">Ø§Ù„Ø´Ø§Øª Ø¨ØªØ§Ø¹Ù†Ø§ ğŸ˜’</span>
          <span id="chatHint" style="font-size:11px;"></span>
        </div>

        <div id="chatMessages" class="chat-messages"></div>

        <form id="chatForm" class="chat-form">
          <button type="button" id="btnAttachFile" class="iconbtn" title="Attach">ğŸ“</button>
          <input type="file" id="chatFileInput" style="display:none" />
          <input id="chatInput" class="chat-input" type="text" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." />
          <button class="btn primary" type="submit" id="btnSend">Ø¥Ø±Ø³Ø§Ù„</button>
        </form>

        <div id="chatFileHint" style="font-size:10px;color:var(--muted)"></div>
      </div>
    </section>

    <aside class="sidebar" id="sidebar">
      <h3 id="sideTitle">Ø§Ù„ØµÙØ­Ø© Ù†ÙˆØ±Øª Ø¨ÙˆØ¬ÙˆØ¯Ùƒ ÙŠØ§ Ø­Ù„ÙˆÙ…Ù‡ ğŸ˜…</h3>
      <p id="sideDesc"></p>

      <div class="section">
        <div class="label" id="myIdLabel">Ø§Ù„Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ</div>
        <div id="myIdBox" class="input" style="user-select:all">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
      </div>

      <div class="section">
        <div class="label" id="remoteLabel">ID Haloma </div>
        <input id="remoteIdInput" class="input" type="text" placeholder="7aloma" />
        <div class="row" style="margin-top:10px">
          <button class="btn primary" type="button" id="btnStartCall">Ø¨Ø¯Ø¡ / Ø¥Ø¶Ø§ÙØ©</button>
          <button class="btn danger" type="button" id="btnEndCall">Ù…ØºØ§Ø¯Ø±Ø©</button>
        </div>
      </div>

      <div class="section">
        <div class="label" id="inviteLabel">Ø±Ø§Ø¨Ø· Ø¯Ø¹ÙˆØ© Ø¶ÙŠÙ</div>
        <input id="inviteLinkInput" class="input" type="text" readonly />
        <div class="row" style="margin-top:10px">
          <button class="btn primary" type="button" id="btnCopyInvite">Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>
        </div>
        <div class="hint" id="inviteHint"></div>
      </div>

      <div class="section">
        <div class="label" id="toolsLabel">Ø£Ø¯ÙˆØ§Øª</div>
        <div class="row">
          <button class="iconbtn" type="button" id="btnToggleCamera" title="Camera">ğŸ¥</button>
          <button class="iconbtn" type="button" id="btnToggleMic" title="Mic">ğŸ™ï¸</button>
          <button class="iconbtn" type="button" id="btnMuteAll" title="Mute all">ğŸ”‡</button>
          <button class="iconbtn" type="button" id="btnShareScreen" title="Share screen">ğŸ–¥ï¸</button>
        </div>
        <div class="hint">Ù„Ùˆ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…Ù‚ÙÙˆÙ„Ø©: Ø§Ø¶ØºØ· ğŸ¥ / ÙˆÙ„Ùˆ Ø§Ù„Ù…Ø§ÙŠÙƒ: ğŸ™ï¸</div>
      </div>
    </aside>
  </main>

  <div class="footer">SUS WEBSITE â€” Private MY Haloma </div>

  <script>
    // =============================
    // Guest mode (meeting-only)
    // =============================
    (function guard(){
      const url = new URL(window.location.href);
      const isGuest = url.searchParams.get("guest") === "1";
      if (isGuest) document.body.classList.add("meeting-only");
    })();

    // =============================
    // Sidebar (IMPORTANT: defined EARLY)
    // =============================
    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("overlay");
    const btnToggleSidebar = document.getElementById("btnToggleSidebar");
    const toggleSidebarText = document.getElementById("toggleSidebarText");
    let sidebarOpen = false;

    function openSidebar(){
      sidebarOpen = true;
      sidebar.classList.add("open");
      const isMobile = window.matchMedia("(max-width: 980px)").matches;
      overlay.style.display = isMobile ? "block" : "none";
      toggleSidebarText.textContent = (getLang()==="en") ? "Close" : "Ø¥ØºÙ„Ø§Ù‚";
    }
    function closeSidebar(){
      sidebarOpen = false;
      sidebar.classList.remove("open");
      overlay.style.display = "none";
      toggleSidebarText.textContent = (getLang()==="en") ? "Controls" : "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§ØªØµØ§Ù„";
    }
    btnToggleSidebar.addEventListener("click", ()=> sidebarOpen ? closeSidebar() : openSidebar());
    overlay.addEventListener("click", closeSidebar);
    window.addEventListener("keydown", (e)=>{ if (e.key==="Escape") closeSidebar(); });

    // default state
    if (!document.body.classList.contains("meeting-only")){
      const isMobile = window.matchMedia("(max-width: 980px)").matches;
      sidebarOpen = !isMobile;
      if (sidebarOpen) openSidebar(); else closeSidebar();
    }

    // =============================
    // Theme + Lang
    // =============================
    function getTheme(){ return localStorage.getItem("sus_theme") || "dark"; }
    function setTheme(m){
      localStorage.setItem("sus_theme", m);
      document.body.classList.toggle("light", m === "light");
      document.getElementById("themeLabel").textContent = (m === "light") ? "Light" : "Dark";
    }
    function getLang(){ return localStorage.getItem("sus_lang") || "ar"; }
    function setLang(l){
      localStorage.setItem("sus_lang", l);
      document.documentElement.lang = (l==="en") ? "en" : "ar";
      document.documentElement.dir  = (l==="en") ? "ltr" : "rtl";
      document.getElementById("langLabel").textContent = (l==="en") ? "EN" : "AR";

      // Update toggle text based on state
      toggleSidebarText.textContent = sidebarOpen
        ? ((l==="en") ? "Close" : "Ø¥ØºÙ„Ø§Ù‚")
        : ((l==="en") ? "Controls" : "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§ØªØµØ§Ù„");
    }

    document.getElementById("btnTheme").addEventListener("click", ()=>{
      setTheme(getTheme()==="light" ? "dark" : "light");
    });
    document.getElementById("btnLang").addEventListener("click", ()=>{
      setLang(getLang()==="ar" ? "en" : "ar");
    });

    setTheme(getTheme());
    setLang(getLang());

    // =============================
    // Fullscreen
    // =============================
    const localVideo = document.getElementById("localVideo");
    document.getElementById("btnFsLocal").addEventListener("click", ()=>{
      if (!document.fullscreenElement) localVideo.requestFullscreen?.().catch(()=>{});
      else document.exitFullscreen?.().catch(()=>{});
    });

    // =============================
    // Peer + Media
    // =============================
    const myIdBox = document.getElementById("myIdBox");
    const inviteLinkInput = document.getElementById("inviteLinkInput");
    const remoteIdInput = document.getElementById("remoteIdInput");
    const remoteVideosGrid = document.getElementById("remoteVideosGrid");
    const callStatus = document.getElementById("callStatus");
    const callTimerEl = document.getElementById("callTimer");
    const participantsCountEl = document.getElementById("participantsCount");

    const btnStartCall = document.getElementById("btnStartCall");
    const btnEndCall = document.getElementById("btnEndCall");
    const btnToggleCamera = document.getElementById("btnToggleCamera");
    const btnToggleMic = document.getElementById("btnToggleMic");
    const btnMuteAll = document.getElementById("btnMuteAll");
    const btnShareScreen = document.getElementById("btnShareScreen");
    const btnCopyInvite = document.getElementById("btnCopyInvite");

    let peer = null;
    let myPeerId = null;

    let cameraStream = null;
    let localStream = null;
    const activeCalls = {};
    const dataConnections = {};
    const remoteStreams = {};

    let isCameraOn = true;
    let isMicOn = true;
    let isScreenSharing = false;

    let callTimerInterval = null;
    let callSecondsElapsed = 0;
    let callInProgress = false;

    function randomIdPart(len){
      const chars = "ABCDEFGHJKMNPQRSTUVWXYZ23456789";
      let out = "";
      for (let i=0;i<len;i++) out += chars[Math.floor(Math.random()*chars.length)];
      return out;
    }
    function buildMyId(){ return "SUS-" + randomIdPart(6) + "-" + randomIdPart(4); }

    function setStatus(text, isError){
      callStatus.textContent = text;
      callStatus.style.color = isError ? "#fecaca" : "var(--accent-2)";
    }

    function formatTime(totalSeconds){
      const m = Math.floor(totalSeconds/60);
      const s = totalSeconds%60;
      return (m<10?("0"+m):(""+m)) + ":" + (s<10?("0"+s):(""+s));
    }
    function startCallTimer(){
      if (callInProgress) return;
      callInProgress = true;
      callSecondsElapsed = 0;
      if (callTimerInterval) clearInterval(callTimerInterval);
      callTimerEl.textContent = "00:00";
      callTimerInterval = setInterval(()=>{
        callSecondsElapsed++;
        callTimerEl.textContent = formatTime(callSecondsElapsed);
      }, 1000);
    }
    function stopCallTimer(reset=true){
      callInProgress = false;
      if (callTimerInterval){
        clearInterval(callTimerInterval);
        callTimerInterval = null;
      }
      if (reset){
        callSecondsElapsed = 0;
        callTimerEl.textContent = "00:00";
      }
    }
    function updateParticipantsCount(){
      participantsCountEl.textContent = 1 + Object.keys(activeCalls).length;
    }

    function updateCameraButtonUI(){
      btnToggleCamera.classList.toggle("off", !isCameraOn);
      btnToggleCamera.textContent = isCameraOn ? "ğŸ¥" : "ğŸš«";
    }
    function updateMicButtonUI(){
      btnToggleMic.classList.toggle("off", !isMicOn);
      btnToggleMic.textContent = isMicOn ? "ğŸ™ï¸" : "ğŸ”‡";
    }

    async function getMediaStream(){
      if (cameraStream){
        localStream = cameraStream;
        localVideo.srcObject = localStream;
        localVideo.classList.add("mirrored");
        return localStream;
      }
      const stream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
      cameraStream = stream;
      localStream = stream;

      isCameraOn = true;
      isMicOn = true;
      stream.getVideoTracks().forEach(t=> t.enabled = true);
      stream.getAudioTracks().forEach(t=> t.enabled = true);

      updateCameraButtonUI();
      updateMicButtonUI();

      localVideo.srcObject = stream;
      localVideo.classList.add("mirrored");
      return stream;
    }

    function switchVideoTrack(newStream){
      if (!newStream) return;
      localStream = newStream;
      localVideo.srcObject = newStream;

      const newTrack = newStream.getVideoTracks()[0];
      if (!newTrack) return;

      Object.values(activeCalls).forEach(call=>{
        const sender = call.peerConnection?.getSenders()?.find(s=> s.track && s.track.kind === "video");
        sender?.replaceTrack(newTrack).catch(()=>{});
      });
    }

    function startScreenShare(){
      if (isScreenSharing) return;
      navigator.mediaDevices.getDisplayMedia({ video:true, audio:false })
        .then(screenStream=>{
          isScreenSharing = true;
          btnShareScreen.classList.add("off");
          btnShareScreen.textContent = "ğŸ›‘";
          localVideo.classList.remove("mirrored");

          const track = screenStream.getVideoTracks()[0];
          track.addEventListener("ended", stopScreenShare);
          switchVideoTrack(screenStream);
        })
        .catch(()=>{});
    }
    function stopScreenShare(){
      if (!isScreenSharing) return;
      isScreenSharing = false;
      btnShareScreen.classList.remove("off");
      btnShareScreen.textContent = "ğŸ–¥ï¸";

      if (localStream && localStream !== cameraStream){
        localStream.getTracks().forEach(t=> t.stop());
      }
      if (cameraStream){
        switchVideoTrack(cameraStream);
        localVideo.classList.add("mirrored");
      }
    }

    function addRemoteVideo(peerId, remoteStream){
      remoteStreams[peerId] = remoteStream;

      let wrapper = document.querySelector(`.remote-video-wrapper[data-peer-id="${peerId}"]`);
      if (!wrapper){
        wrapper = document.createElement("div");
        wrapper.className = "remote-video-wrapper";
        wrapper.dataset.peerId = peerId;

        const v = document.createElement("video");
        v.autoplay = true; v.playsInline = true;
        v.srcObject = remoteStream;

        const label = document.createElement("div");
        label.className = "remote-peer-label";
        label.textContent = peerId;

        wrapper.appendChild(v);
        wrapper.appendChild(label);
        remoteVideosGrid.appendChild(wrapper);
      }else{
        const v = wrapper.querySelector("video");
        if (v) v.srcObject = remoteStream;
      }
    }

    function removeRemoteVideo(peerId){
      delete remoteStreams[peerId];
      const wrapper = document.querySelector(`.remote-video-wrapper[data-peer-id="${peerId}"]`);
      wrapper?.remove();
    }

    function bindCallEvents(call){
      const pid = call.peer;
      activeCalls[pid] = call;

      setStatus("Ù…ÙƒØ§Ù„Ù…Ø© Ù†Ø´Ø·Ø©", false);
      startCallTimer();
      updateParticipantsCount();

      call.on("stream", (remoteStream)=> addRemoteVideo(pid, remoteStream));
      call.on("close", ()=>{
        removeRemoteVideo(pid);
        delete activeCalls[pid];
        updateParticipantsCount();
        if (Object.keys(activeCalls).length === 0){
          stopCallTimer();
          setStatus("ØªÙ… Ø§Ù„Ø¥ØºÙ„Ø§Ù‚", true);
        }
      });
    }

    function ensureDataConnection(peerId){
      if (!peer || peerId === myPeerId) return null;
      if (dataConnections[peerId]) return dataConnections[peerId];

      const conn = peer.connect(peerId);
      conn.on("open", ()=>{ dataConnections[peerId] = conn; });
      conn.on("close", ()=>{ delete dataConnections[peerId]; });
      return conn;
    }

    function addParticipantById(remoteId){
      if (!remoteId || remoteId === myPeerId) return;
      getMediaStream().then(stream=>{
        if (!activeCalls[remoteId]){
          const call = peer.call(remoteId, stream);
          bindCallEvents(call);
        }
        ensureDataConnection(remoteId);
      }).catch(()=>{
        setStatus("Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§/Ø§Ù„Ù…Ø§ÙŠÙƒ Ù…Ø±ÙÙˆØ¶ÙŠÙ†. Ø§Ø³Ù…Ø­ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­.", true);
      });
    }

    function initPeer(){
      myPeerId = buildMyId();
      peer = new Peer(myPeerId, { debug: 2 });

      peer.on("open", (id)=>{
        myIdBox.textContent = id;
        setStatus("Ø¬Ø§Ù‡Ø²", false);

        // Invite link
        const base = window.location.href.split("?")[0];
        const u = new URL(base, window.location.href);
        u.searchParams.set("host", id);
        u.searchParams.set("guest", "1");
        inviteLinkInput.value = u.toString();
      });

      peer.on("call", (call)=>{
        setStatus("Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§ØªØµØ§Ù„...", false);
        getMediaStream().then(stream=>{
          call.answer(stream);
          bindCallEvents(call);
          ensureDataConnection(call.peer);
        }).catch(()=>{
          setStatus("Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§/Ø§Ù„Ù…Ø§ÙŠÙƒ Ù…Ø±ÙÙˆØ¶ÙŠÙ†. Ø§Ø³Ù…Ø­ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­.", true);
        });
      });

      peer.on("error", (err)=>{
        console.error(err);
        setStatus("PeerJS Error", true);
      });
    }

    // Buttons
    btnToggleCamera.addEventListener("click", ()=>{
      if (isScreenSharing) { alert("Ø£ÙˆÙ‚Ù Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø© Ø£ÙˆÙ„Ø§Ù‹"); return; }
      const s = cameraStream || localStream;
      if (!s) return;
      const tracks = s.getVideoTracks();
      if (!tracks?.length) return;
      isCameraOn = !isCameraOn;
      tracks.forEach(t=> t.enabled = isCameraOn);
      updateCameraButtonUI();
    });

    btnToggleMic.addEventListener("click", ()=>{
      const s = cameraStream || localStream;
      if (!s) return;
      const tracks = s.getAudioTracks();
      if (!tracks?.length) return;
      isMicOn = !isMicOn;
      tracks.forEach(t=> t.enabled = isMicOn);
      updateMicButtonUI();
    });

    btnMuteAll.addEventListener("click", ()=>{
      const s = cameraStream || localStream;
      if (s) s.getAudioTracks().forEach(t=> t.enabled = false);
      isMicOn = false; updateMicButtonUI();
    });

    btnShareScreen.addEventListener("click", ()=> isScreenSharing ? stopScreenShare() : startScreenShare());

    btnStartCall.addEventListener("click", ()=>{
      const rid = (remoteIdInput.value || "").trim();
      if (!rid) { alert("Ø§ÙƒØªØ¨ ID Ø§Ù„Ø£ÙˆÙ„"); return; }
      setStatus("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...", false);
      addParticipantById(rid);
      if (window.matchMedia("(max-width: 980px)").matches) closeSidebar();
    });

    btnEndCall.addEventListener("click", ()=>{
      Object.values(activeCalls).forEach(c=>{ try{ c.close(); }catch{} });
      for (const k in activeCalls) delete activeCalls[k];

      remoteVideosGrid.querySelectorAll(".remote-video-wrapper").forEach(w=> w.remove());

      if (cameraStream){ cameraStream.getTracks().forEach(t=> t.stop()); cameraStream = null; }
      localStream = null;
      localVideo.srcObject = null;

      stopCallTimer(true);
      updateParticipantsCount();
      setStatus("Ø¬Ø§Ù‡Ø²", false);
    });

    btnCopyInvite.addEventListener("click", async ()=>{
      const v = inviteLinkInput.value || "";
      if (!v) return;
      try { await navigator.clipboard.writeText(v); alert("ØªÙ… Ø§Ù„Ù†Ø³Ø®"); }
      catch { inviteLinkInput.select(); document.execCommand("copy"); alert("ØªÙ… Ø§Ù„Ù†Ø³Ø®"); }
    });

    // Chat (light)
    const chatMessagesEl = document.getElementById("chatMessages");
    const chatForm = document.getElementById("chatForm");
    const chatInput = document.getElementById("chatInput");
    const chatFileInput = document.getElementById("chatFileInput");
    const chatFileHint = document.getElementById("chatFileHint");
    let pendingFile = null;

    function appendChatMessage({ from, text, isOwn, file }){
      const msg = document.createElement("div");
      msg.className = "msg" + (isOwn ? " own" : "");
      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = isOwn ? "YOU" : (from || "PEER");
      msg.appendChild(meta);
      if (text){ const b = document.createElement("div"); b.textContent = text; msg.appendChild(b); }
      if (file?.dataUrl && file?.name){
        const a = document.createElement("a");
        a.href = file.dataUrl; a.download = file.name;
        a.textContent = `ğŸ“ ${file.name}`;
        msg.appendChild(a);
      }
      chatMessagesEl.appendChild(msg);
      chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
    }

    document.getElementById("btnAttachFile").addEventListener("click", ()=> chatFileInput.click());
    chatFileInput.addEventListener("change", ()=>{
      const file = chatFileInput.files?.[0];
      if (!file){ pendingFile=null; chatFileHint.textContent=""; return; }
      const maxSize = 2*1024*1024;
      if (file.size>maxSize){ alert("Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± (2MB)"); chatFileInput.value=""; return; }
      const r = new FileReader();
      r.onload = ()=>{ pendingFile = { name:file.name, dataUrl:r.result }; chatFileHint.textContent = "Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¥Ø±Ø³Ø§Ù„"; };
      r.readAsDataURL(file);
    });

    chatForm.addEventListener("submit", (e)=>{
      e.preventDefault();
      const text = (chatInput.value||"").trim();
      if (!text && !pendingFile) return;
      appendChatMessage({ from: myPeerId, text, isOwn:true, file: pendingFile });
      chatInput.value=""; pendingFile=null; chatFileHint.textContent=""; chatFileInput.value="";
    });

    // Auto connect for guest
    function autoConnectIfGuest(){
      const url = new URL(window.location.href);
      const hostId = url.searchParams.get("host");
      if (hostId){
        remoteIdInput.value = hostId;
        setTimeout(()=> addParticipantById(hostId), 1000);
      }
    }

    // Init
    initPeer();
    window.addEventListener("load", ()=>{
      getMediaStream().catch(()=>{
        setStatus("Ø§Ø³Ù…Ø­ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§/Ø§Ù„Ù…Ø§ÙŠÙƒ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­", true);
      });
      updateParticipantsCount();
      autoConnectIfGuest();
    });
  </script>
</body>
</html>

